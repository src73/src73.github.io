<!DOCTYPE html>
<html>
<head>
	<title>2019 US Commerical Flight Routes</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<meta name="apple-mobile-web-app-capable" content="yes">

	<link rel="stylesheet" href="plugins/leaflet/leaflet.css" />
	<script src="plugins/leaflet/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src='air-data.js'></script>
	<link rel="stylesheet" href="style/style2.css"/>
</head>
<body>	        
	<div id="map" style="width:100%; height:100%; "></div>

<!--
* 2019 air data showing the number of seats flown by airlines on routes that start in the United States
* line weight corresponds to the number of seats available
* routes with 1 million seats flown per year (or more) are shown in red. There are about 50 such routes
* the smallest route shown is one with the annual seats flown between between ORD and ATW. 
-->

	<script>

// Use OpenStreetMap standard Mapnik tiles
var baseMap = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
    maxZoom: 19
})




map = L.map("map", {
	center: [25.878994400196202, -107.49023437500001],
	zoom: 3,
    //minZoom: 4,
    //maxZoom: 10,
	layers: [baseMap],
        zoomControl: true
	});

// Store polylines with their data for zoom-based scaling
var polylines = [];

// Function to calculate zoom multiplier (lines get thicker when zoomed in)
function getZoomMultiplier(zoom) {
	// At zoom 3 (country level), multiplier is 1
	// At zoom 10+ (city level), multiplier is ~5
	return Math.pow(1.25, zoom - 3);
}

// Function to update all line weights based on current zoom
function updateLineWeights() {
	var zoom = map.getZoom();
	var zoomMult = getZoomMultiplier(zoom);

	polylines.forEach(function(item) {
		var baseWeight = 1 * item.data.seats / 2266056 * item.data.mult;
		item.polyline.setStyle({ weight: baseWeight * zoomMult });
	});
}

latlngs.reverse().map(function(l) {


	// fix routes to Japan
	// https://github.com/leaflet/leaflet/issues/82
	if(l.coords[0][1] > 100) {
		l.coords[0][1] = l.coords[0][1] - 360
	}
	if(l.coords[1][1] > 100) {
		l.coords[1][1] = l.coords[1][1] - 360
	}

	var theColor = 'blue'
	var mult = 1

	if (l.seats > 1000000) {
		theColor='red'
		mult = 2
	}

	var baseWeight = 1 * l.seats / 2266056 * mult;
	var zoomMult = getZoomMultiplier(map.getZoom());

	var polyline = L.polyline(l.coords, {
		color: theColor,
		weight: baseWeight * zoomMult,
		opacity:0.5
	}).addTo(map);

	// Store polyline and its data for later updates
	polylines.push({
		polyline: polyline,
		data: {
			seats: l.seats,
			mult: mult,
			coords: l.coords,
			color: theColor
		}
	});
})

// Update line weights when zoom changes
map.on('zoomend', updateLineWeights);

// Track highlighted routes
var highlightedRoutes = [];

// Helper function to check if two coordinates are the same
function coordsEqual(coord1, coord2) {
	return Math.abs(coord1[0] - coord2[0]) < 0.0001 && Math.abs(coord1[1] - coord2[1]) < 0.0001;
}

// Function to reset all highlights
function resetHighlights() {
	highlightedRoutes.forEach(function(item) {
		item.polyline.setStyle({
			opacity: 0.5,
			color: item.data.color
		});
	});
	highlightedRoutes = [];
}

// Function to highlight connected routes
function highlightConnectedRoutes(clickedItem) {
	// Reset any existing highlights
	resetHighlights();

	var endpoints = clickedItem.data.coords;
	var endpoint1 = endpoints[0];
	var endpoint2 = endpoints[1];

	// Find all connected routes
	polylines.forEach(function(item) {
		var itemEndpoints = item.data.coords;
		var itemEnd1 = itemEndpoints[0];
		var itemEnd2 = itemEndpoints[1];

		// Check if this route shares an endpoint with the clicked route
		if (coordsEqual(endpoint1, itemEnd1) || coordsEqual(endpoint1, itemEnd2) ||
		    coordsEqual(endpoint2, itemEnd1) || coordsEqual(endpoint2, itemEnd2)) {
			// Highlight this route
			item.polyline.setStyle({
				opacity: 0.9,
				color: '#00ff00'  // Bright green for highlighted routes
			});
			highlightedRoutes.push(item);
		}
	});
}

// Add click handlers to all polylines
polylines.forEach(function(item) {
	item.polyline.on('click', function(e) {
		highlightConnectedRoutes(item);
		L.DomEvent.stopPropagation(e);
	});
});

// Click on map to clear highlights
map.on('click', function() {
	resetHighlights();
});

map.attributionControl.addAttribution(' | 2019 air travel data from <a href="https://www.transtats.bts.gov/">Bureau of Transportation Statistics</a>')

// var polyline = L.polyline(latlngs, {color: 'red'}).addTo(map);



	</script>
</body>
</html>
